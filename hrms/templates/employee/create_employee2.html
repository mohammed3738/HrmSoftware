{% extends 'base2.html' %} {% block body %} {% load widget_tweaks %}
<div class="container-xxl flex-grow-1 container-p-y">
  <!-- DataTable with Buttons -->
  <div class="card">
    <!-- Card Header with Title -->
    <div class="card-body">
      <!-- Upper Control Row: Two Buttons on the Right -->
      <div class="row mb-3">
        <div class="col">
          <!-- Empty left side or you can add text here if needed -->
          <h5 class="card-header">Employees</h5>
        </div>
        <div class="col-auto d-flex align-items-center">
          <button
            type="button"
            class="btn btn-secondary buttons-collection dropdown-toggle btn-label-primary me-4 waves-effect waves-light"
            onclick="downloadEmployees()"
          >
            Export
          </button>
          <button
            type="button"
            class="btn btn-secondary create-new btn-primary waves-effect waves-light"
            data-bs-toggle="modal"
            data-bs-target="#employeeModal"
          >
            Add Employee
          </button>
        </div>
      </div>
      <hr />
      <!-- Lower Control Row: Entries Info on Left and Search Bar on Right -->
      <div class="row mb-3">
        <div class="col-md-6 d-flex align-items-center">
          <!-- Example entries info; you can update this as needed -->
          <div>Showing 1 to 10 of 50 entries</div>
        </div>
        <div
          class="col-md-6 d-flex justify-content-end align-items-center gap-2"
        >
          <!-- Search Input -->
          <input
            type="text"
            id="searchInput"
            class="form-control form-control-sm"
            placeholder="Search..."
            style="max-width: 200px"
          />

          <!-- Status Filter -->
          <select
            id="statusFilter"
            class="form-select form-select-sm"
            style="max-width: 150px"
          >
            <option value="all">All</option>
            <option value="Active">Active</option>
            <option value="Pending">Pending</option>
          </select>
        </div>
      </div>
      <!-- Table -->
      <div class="table-responsive text-nowrap">
        <table class="table">
          <thead>
            <tr>
              <th>Employee Code</th>
              <th>Company</th>
              <th>Branch</th>
              <th>Salutation</th>
              <th>First Name</th>
              <th>Middle Name</th>
              <th>Last Name</th>
              <th>Father's Name</th>
              <th>Gender</th>
              <!-- <th>Blood Group</th>
              <th>Date of Birth</th>
              <th>Place of Birth</th>
              <th>Personal Email</th>
              <th>Present Address</th>
              <th>Permanent Address</th>
              <th>Personal Mobile</th>
              <th>Date of Marriage</th>
              <th>Designation</th>
              <th>Department</th>
              <th>Date of Joining</th>
              <th>Date of Confirmation</th>
              <th>Location</th>
              <th>Shift</th>
              <th>PAN No</th>
              <th>Aadhar No</th>
              <th>Voter ID</th>
              <th>Passport</th>
              <th>UAN No</th>
              <th>PF No</th>
              <th>ESIC No</th>
              <th>Name As Per Bank Record</th>
              <th>Salary Account Number</th>
              <th>IFSC Code</th>
              <th>Emergency Contact Name 1</th>
              <th>Emergency Contact Relation 1</th>
              <th>Emergency Contact Mobile 1</th>
              <th>Emergency Contact Name 2</th>
              <th>Emergency Contact Relation 2</th>
              <th>Emergency Contact Mobile 2</th> -->
              <th>Status</th>
              <th class="sticky-actions">Actions</th>
            </tr>
          </thead>
          <tbody class="table-border-bottom-0">
            {% for employee in employees %}
            <tr>
              <td>
                <a href="{% url 'employee_detail' employee.pk %}"
                  >{{employee.employee_code}}</a
                >
              </td>

              <td>
                <a href="{% url 'create-company' %}">{{employee.company}}</a>
              </td>
              <td>
                <p class="text-dark mb-0">
                  <a
                    href="https://smarthr.dreamstechnologies.com/html/template/employee-details.html"
                    data-bs-toggle="modal"
                    data-bs-target="#view_details"
                    >{{employee.branch}}</a
                  >
                </p>
              </td>

              <td>{{employee.salutation}}</td>
              <td>{{employee.first_name}}</td>
              <td>{{employee.middle_name}}</td>
              <td>{{employee.last_name}}</td>
              <td>{{employee.father_name}}</td>
              <td>{{employee.gender}}</td>
              <!-- <td>{{employee.blood_group}}</td>
              <td>{{employee.date_of_birth}}</td>
              <td>{{employee.place_of_birth}}</td>
              <td>{{employee.personal_email}}</td>
              <td>{{employee.present_address}}</td>
              <td>{{employee.permanent_address}}</td>
              <td>{{employee.personal_mobile}}</td>
              <td>{{employee.date_of_marriage}}</td>
              <td>{{employee.designation}}</td>
              <td>{{employee.department}}</td>
              <td>{{employee.date_of_joining}}</td>
              <td>{{employee.date_of_confirmation}}</td>
              <td>{{employee.location}}</td>
              <td>{{employee.shift}}</td>
              <td>{{employee.pan_no}}</td>
              <td>{{employee.aadhar_no}}</td>
              <td>{{employee.voter_id}}</td>
              <td>{{employee.passport}}</td>
              <td>{{employee.uan_no}}</td>
              <td>{{employee.pf_no}}</td>
              <td>{{employee.esic_no}}</td>
              <td>{{employee.name_as_per_bank}}</td>
              <td>{{employee.salary_account_number}}</td>
              <td>{{employee.ifsc_code}}</td>
              <td>{{employee.emergency_contact_name1}}</td>
              <td>{{employee.emergency_contact_relation1}}</td>
              <td>{{employee.emergency_contact_mobile1}}</td>
              <td>{{employee.emergency_contact_name2}}</td> 
              <td>{{employee.emergency_contact_relation2}}</td>
              <td>{{employee.emergency_contact_mobile2}}</td> -->
              <td>
                {% if employee.status == "Active" %}
                <p style="color: red">{{employee.status}}</p>
                {% elif employee.status == "Pending" %}
                <p style="color: yellow">{{employee.status}}</p>

                {% endif %}
              </td>

              <td>
                <div class="dropdown">
                  <button
                    type="button"
                    class="btn p-0 dropdown-toggle hide-arrow"
                    data-bs-toggle="dropdown"
                  >
                    <i class="ri-more-2-line"></i>
                  </button>
                  <div class="dropdown-menu">
                    <a
                      href="#"
                      class="dropdown-item edit-employee-btn"
                      data-id="{{ employee.id }}"
                    >
                      <i class="ti ti-edit me-2"></i> Edit
                    </a>
                    <a
                      class="dropdown-item text-danger"
                      href="javascript:void(0);"
                      onclick="confirmEmployeeDelete({{ employee.id }})"
                    >
                      <i class="ri-delete-bin-7-line me-2"></i> Delete
                    </a>
                  </div>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  {% comment %} employee modal {% endcomment %}

  <!-- ==========================
     EMPLOYEE EDIT MODAL
========================== -->
  <div
    class="modal fade"
    id="editEmployeeModal"
    tabindex="-1"
    aria-hidden="true"
  >
    <div class="modal-dialog modal-xl modal-dialog-centered">
      <div class="modal-content">
        <div
          class="modal-header bg-primary bg-gradient text-white rounded-top-4 py-3"
        >
          <h5 class="modal-title fw-bold d-flex align-items-center text-white">
            <i class="ti ti-building-bank me-2 fs-4 text-white"></i> Edit
            Employee Details
          </h5>
          <button
            type="button"
            class="btn-close btn-close-white text-white"
            data-bs-dismiss="modal"
          ></button>
        </div>

        <div class="modal-body" id="editEmployeeBody">
          <div class="text-center text-muted p-3">Loading...</div>
        </div>
      </div>
    </div>
  </div>

   {% load widget_tweaks %}

  <div
    class="modal fade"
    id="employeeModal"
    tabindex="-1"
    aria-labelledby="employeeModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <form
          method="POST"
          enctype="multipart/form-data"
          id="employeeCreateForm"
        >
          {% csrf_token %}
        <div id="hidden-nested-files"></div>

          <div class="modal-header">
            <h5 class="modal-title">Add Employee</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>

          <div class="modal-body">
            <!-- Tabs -->
            <ul class="nav nav-underline mb-3" role="tablist">
              <li class="nav-item">
                <button
                  class="nav-link active"
                  data-bs-toggle="tab"
                  data-bs-target="#basic-info"
                  type="button"
                >
                  Basic Information
                </button>
              </li>
              <li class="nav-item">
                <button
                  class="nav-link"
                  data-bs-toggle="tab"
                  data-bs-target="#previous-employment"
                  type="button"
                >
                  Previous Employment
                </button>
              </li>
              <li class="nav-item">
                <button
                  class="nav-link"
                  data-bs-toggle="tab"
                  data-bs-target="#attachment"
                  type="button"
                >
                  Attachment
                </button>
              </li>
            </ul>

            <div class="tab-content">
              <!-- BASIC INFO TAB -->
              <div class="tab-pane fade show active" id="basic-info">
                <div class="row">
                  <!-- COMPANY -->
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label class="form-label"
                        >Company <span class="text-danger">*</span></label
                      >
                      {{ form.company|add_class:"form-control" }} 
                      {% for error in form.company.errors %}
                      <div class="text-danger small">{{ error }}</div>
                      {% endfor %}
                    </div>
                  </div>

                  <!-- BRANCH -->
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label class="form-label"
                        >Branch <span class="text-danger">*</span></label
                      >
                      {{ form.branch|add_class:"form-control" }}
                      {% for error in form.branch.errors %}
                      <div class="text-danger small">{{ error }}</div>
                      {% endfor %}
                    </div>
                  </div>

                  <!-- SALUTATION -->
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label class="form-label">Salutation</label>
                      {{ form.salutation|add_class:"form-control" }}
                      {% for error in form.salutation.errors %}
                      <div class="text-danger small">{{ error }}</div>
                      {% endfor %}
                    </div>
                  </div>

                  <!-- FIRST NAME -->
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label class="form-label"
                        >First Name <span class="text-danger">*</span></label
                      >
                      {{ form.first_name|add_class:"form-control" }}
                      {% for error in form.first_name.errors %}
                      <div class="text-danger small">{{ error }}</div>
                      {% endfor %}
                    </div>
                  </div>

                  <!-- MIDDLE NAME -->
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label class="form-label">Middle Name</label>
                      {{ form.middle_name|add_class:"form-control" }}
                      {% for error in form.middle_name.errors %}
                      <div class="text-danger small">{{ error }}</div>
                      {% endfor %}
                    </div>
                  </div>

                  <!-- LAST NAME -->
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label class="form-label"
                        >Last Name <span class="text-danger">*</span></label
                      >
                      {{ form.last_name|add_class:"form-control" }} 
                      {% for error in form.last_name.errors %}
                      <div class="text-danger small">{{ error }}</div>
                      {% endfor %}
                    </div>
                  </div>

                  <!-- Continue the same pattern for ALL OTHER FIELDS -->
                  <!-- I will not shorten anything. Full exact HTML continues belowâ€¦ -->

                  <!-- FATHER NAME -->
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label class="form-label">Father's Name</label>
                      {{ form.father_name|add_class:"form-control" }}
                      {% for error in form.father_name.errors %}
                      <div class="text-danger small">{{ error }}</div>
                      {% endfor %}
                    </div>
                  </div>

                  <!-- GENDER -->
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label class="form-label"
                        >Gender <span class="text-danger">*</span></label
                      >
                      {{ form.gender|add_class:"form-control" }}
                      {% for error in form.gender.errors %}
                      <div class="text-danger small">{{ error }}</div>
                      {% endfor %}
                    </div>
                  </div>

                  <!-- BLOOD GROUP -->
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label class="form-label">Blood Group</label>
                      {{ form.blood_group|add_class:"form-control" }} 
                      {% for error in form.blood_group.errors %}
                      <div class="text-danger small">{{ error }}</div>
                      {% endfor %}
                    </div>
                  </div>

                  <!-- DATE OF BIRTH -->
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label class="form-label"
                        >Date of Birth <span class="text-danger">*</span></label
                      >
                      {{ form.date_of_birth|add_class:"form-control" }}
                      {% for error in form.date_of_birth.errors %}
                      <div class="text-danger small">{{ error }}</div>
                      {% endfor %}
                    </div>
                  </div>

                  <!-- PLACE OF BIRTH -->
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label class="form-label">Place of Birth</label>
                      {{ form.place_of_birth|add_class:"form-control" }} 
                      {% for error in form.place_of_birth.errors %}
                      <div class="text-danger small">{{ error }}</div>
                      {% endfor %}
                    </div>
                  </div>

                  <!-- EMAIL -->
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label class="form-label"
                        >Personal Email
                        <span class="text-danger">*</span></label
                      >
                      {{ form.personal_email|add_class:"form-control" }}
                       {% for error in form.personal_email.errors %}
                      <div class="text-danger small">{{ error }}</div>
                      {% endfor %}
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label class="form-label"
                        >Present Address
                        <span class="text-danger">*</span></label
                      >
                      {{ form.present_address|add_class:"form-control" }}
                      {% for error in form.present_address.errors %}
                      <div class="text-danger small">{{ error }}</div>
                      {% endfor %}
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label class="form-label"
                        >Permanent Address
                        <span class="text-danger">*</span></label
                      >
                      {{ form.permanent_address|add_class:"form-control" }}
                       {% for error in form.permanent_address.errors %}
                      <div class="text-danger small">{{ error }}</div>
                      {% endfor %}
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label class="form-label"
                        >Personal Mobile No
                        <span class="text-danger">*</span></label
                      >
                      {{ form.personal_mobile|add_class:"form-control" }}
                      {% for error in form.personal_mobile.errors %}
                      <div class="text-danger small">{{ error }}</div>
                      {% endfor %}
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label class="form-label">Date of Marriage</label>
                      {{ form.date_of_marriage|add_class:"form-control" }}
                      {% for error in form.date_of_marriage.errors %}
                      <div class="text-danger small">{{ error }}</div>
                      {% endfor %}
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label class="form-label"
                        >Employee Code <span class="text-danger">*</span></label
                      >
                      {{ form.employee_code|add_class:"form-control" }}
                      {% for error in form.employee_code.errors %}
                      <div class="text-danger small">{{ error }}</div>
                      {% endfor %}
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label class="form-label"
                        >Designation <span class="text-danger">*</span></label
                      >
                      {{ form.designation|add_class:"form-control" }}
                      {% for error in form.designation.errors %}
                      <div class="text-danger small">{{ error }}</div>
                      {% endfor %}
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label class="form-label"
                        >Department <span class="text-danger">*</span></label
                      >
                      {{ form.department|add_class:"form-control" }}
                      {% for error in form.department.errors %}
                      <div class="text-danger small">{{ error }}</div>
                      {% endfor %}
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label class="form-label"
                        >Date Of Joining
                        <span class="text-danger">*</span></label
                      >
                      {{ form.date_of_joining|add_class:"form-control" }}
                       {% for error in form.date_of_joining.errors %}
                      <div class="text-danger small">{{ error }}</div>
                      {% endfor %}
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label class="form-label"
                        >Location <span class="text-danger">*</span></label
                      >
                      {{ form.location|add_class:"form-control" }} 
                      {% for error in form.location.errors %}
                      <div class="text-danger small">{{ error }}</div>
                      {% endfor %}
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label class="form-label"
                        >Shift <span class="text-danger">*</span></label
                      >
                      {{ form.shift|add_class:"form-control" }}
                       {% for error in form.shift.errors %}
                      <div class="text-danger small">{{ error }}</div>
                      {% endfor %}
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label class="form-label"
                        >PAN No <span class="text-danger">*</span></label
                      >
                      {{ form.pan_no|add_class:"form-control" }}
                      {% for error in form.pan_no.errors %}
                      <div class="text-danger small">{{ error }}</div>
                      {% endfor %}
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label class="form-label"
                        >Aadhar No <span class="text-danger">*</span></label
                      >
                      {{ form.aadhar_no|add_class:"form-control" }}
                      {% for error in form.aadhar_no.errors %}
                      <div class="text-danger small">{{ error }}</div>
                      {% endfor %}
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label class="form-label"
                        >Voter ID <span class="text-danger">*</span></label
                      >
                      {{ form.voter_id|add_class:"form-control" }}
                      {% for error in form.voter_id.errors %}
                      <div class="text-danger small">{{ error }}</div>
                      {% endfor %}
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label class="form-label"
                        >Passport <span class="text-danger">*</span></label
                      >
                      {{ form.passport|add_class:"form-control" }}
                      {% for error in form.passport.errors %}
                      <div class="text-danger small">{{ error }}</div>
                      {% endfor %}
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label class="form-label"
                        >UAN No <span class="text-danger">*</span></label
                      >
                      {{ form.uan_no|add_class:"form-control" }}
                      {% for error in form.uan_no.errors %}
                      <div class="text-danger small">{{ error }}</div>
                      {% endfor %}
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label class="form-label"
                        >PF No <span class="text-danger">*</span></label
                      >
                      {{ form.pf_no|add_class:"form-control" }}
                      {% for error in form.pf_no.errors %}
                      <div class="text-danger small">{{ error }}</div>
                      {% endfor %}
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label class="form-label"
                        >ESIC No <span class="text-danger">*</span></label
                      >
                      {{ form.esic_no|add_class:"form-control" }}
                       {% for error in form.esic_no.errors %}
                      <div class="text-danger small">{{ error }}</div>
                      {% endfor %}
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label class="form-label"
                        >Name As Per Bank Record
                        <span class="text-danger">*</span></label
                      >
                      {{ form.name_as_per_bank|add_class:"form-control" }}
                      {% for error in form.name_as_per_bank.errors %}
                      <div class="text-danger small">{{ error }}</div>
                      {% endfor %}
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label class="form-label"
                        >Salary Account Number
                        <span class="text-danger">*</span></label
                      >
                      {{ form.salary_account_number|add_class:"form-control" }}
                      {% for error in form.salary_account_number.errors %}
                      <div class="text-danger small">{{ error }}</div>
                      {% endfor %}
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label class="form-label"
                        >IFSC Code <span class="text-danger">*</span></label
                      >
                      {{ form.ifsc_code|add_class:"form-control" }}
                       {% for error in form.ifsc_code.errors %}
                      <div class="text-danger small">{{ error }}</div>
                      {% endfor %}
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label class="form-label"
                        >Emergency Contact Name 1
                        <span class="text-danger">*</span></label
                      >
                      {{ form.emergency_contact_name1|add_class:"form-control"}}
                      {% for error in form.emergency_contact_name1.errors %}
                      <div class="text-danger small">{{ error }}</div>
                      {% endfor %}
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label class="form-label"
                        >Emergency Contact Relation 1
                        <span class="text-danger">*</span></label
                      >
                      {{ form.emergency_contact_relation1|add_class:"form-control"}} 
                      {% for error in form.emergency_contact_relation1.errors %}
                      <div class="text-danger small">{{ error }}</div>
                      {% endfor %}
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label class="form-label"
                        >Emergency Contact Mobile No 1
                        <span class="text-danger">*</span></label
                      >
                      {{ form.emergency_contact_mobile1|add_class:"form-control" }} 
                      {% for error in form.emergency_contact_mobile1.errors %}
                      <div class="text-danger small">{{ error }}</div>
                      {% endfor %}
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label class="form-label"
                        >Emergency Contact Name 2
                        <span class="text-danger">*</span></label
                      >
                      {{ form.emergency_contact_name2|add_class:"form-control" }} 
                      {% for error in form.emergency_contact_name2.errors %}
                      <div class="text-danger small">{{ error }}</div>
                      {% endfor %}
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label class="form-label"
                        >Emergency Contact Relation 2
                        <span class="text-danger">*</span></label
                      >
                      {{ form.emergency_contact_relation2|add_class:"form-control" }} 
                      {% for error in form.emergency_contact_relation2.errors %}
                      <div class="text-danger small">{{ error }}</div>
                      {% endfor %}
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label class="form-label"
                        >Emergency Contact Mobile No 2
                        <span class="text-danger">*</span></label
                      >
                      {{ form.emergency_contact_mobile2|add_class:"form-control" }}
                      {% for error in form.emergency_contact_mobile2.errors %}
                      <div class="text-danger small">{{ error }}</div>
                      {% endfor %}
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label class="form-label"
                        >Status <span class="text-danger">*</span></label
                      >
                      {{ form.status|add_class:"form-control" }} 
                      {% for error in form.status.errors %}
                      <div class="text-danger small">{{ error }}</div>
                      {% endfor %}
                    </div>
                  </div>

                  <!-- Continue similarly for ALL remaining fieldsâ€¦ -->
                  <!-- I will not shorten anything. You will receive the full final HTML. -->
                </div>
              </div>

              <!-- ============= PREVIOUS EMPLOYMENT TAB ============= -->
              <div class="tab-pane fade" id="previous-employment">

                  {{ formset.management_form }}

                  <div class="table-responsive">
                      <table class="table table-bordered" id="prevEmploymentTable">
                          <thead class="table-light">
                              <tr>
                                  <th>Employer Name</th>
                                  <th>From</th>
                                  <th>To</th>
                                  <th>Last CTC</th>
                                  <th>Attachments</th>
                                  <th>Actions</th>
                              </tr>
                          </thead>

                          <tbody>
                            {% for f in formset %}
                            {% with forloop.counter0 as idx %}
                            <tr>
                                <td style="display:none">{{ f.id }}</td>
                                <td>{{ f.employer_name|add_class:"form-control" }}</td>
                                <td>{{ f.from_date|add_class:"form-control" }}</td>
                                <td>{{ f.to_date|add_class:"form-control" }}</td>
                                <td>{{ f.last_ctc|add_class:"form-control" }}</td>

                                <td>
                                  <button type="button"
                                      class="btn btn-primary btn-sm manage-documents"
                                      data-index="{{ forloop.counter0 }}">
                                      ðŸ“Ž Manage Documents
                                  </button>
                                </td>

                                <td>
                                    {% if f.instance.pk %}
                                        {{ f.DELETE }} Delete
                                    {% else %}
                                        <button type="button" class="btn btn-danger btn-sm remove-prev-row">Remove</button>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endwith %}
                            {% endfor %}
                          </tbody>

                      </table>
                  </div>

                  <button type="button" id="addPrevRow" class="btn btn-secondary btn-sm mt-2">
                      Add Previous Employment
                  </button>

                  <!-- Hidden empty row template for Previous Employment -->
              <table style="display:none">
                  <tbody id="prev-empty-row">
                      <tr>
                          <td style="display:none">{{ formset.empty_form.id }}</td>
                          <td>{{ formset.empty_form.employer_name|add_class:"form-control" }}</td>
                          <td>{{ formset.empty_form.from_date|add_class:"form-control" }}</td>
                          <td>{{ formset.empty_form.to_date|add_class:"form-control" }}</td>
                          <td>{{ formset.empty_form.last_ctc|add_class:"form-control" }}</td>

                          <td>
                              <button type="button"
                                  class="btn btn-primary btn-sm manage-documents"
                                  data-index="__prefix__">
                                  ðŸ“Ž Manage Documents
                              </button>
                          </td>

                          <td>
                              <button type="button" class="btn btn-danger btn-sm remove-prev-row">
                                  Remove
                              </button>
                          </td>
                      </tr>
                  </tbody>
              </table>

              </div>

              <!-- ============= ATTACHMENT TAB ============= -->
              <div class="tab-pane fade" id="attachment">
                {{ attachment_formset.management_form }}

                <div class="table-responsive">
                  <table class="table table-bordered" id="attachmentTable">
                    <thead class="table-light">
                      <tr>
                        <th>File</th>
                        <th>Actions</th>
                      </tr>
                    </thead>

                    <tbody>
                      {% for f in attachment_formset %}
                      <tr>
                        <td>{{ f.id }}</td>

                        <td>
                          {{ f.file }} {% if f.instance.pk and f.instance.file %}
                          <small class="d-block mt-1"
                            >Existing:
                            <a href="{{ f.instance.file.url }}" target="_blank">
                              {{ f.instance.file.name }}
                            </a>
                          </small>
                          {% endif %} {% for error in f.file.errors %}
                          <div class="text-danger small">{{ error }}</div>
                          {% endfor %}
                        </td>

                        <td>
                          {% if f.instance.pk %}
                          <div class="form-check">
                            {{ f.DELETE }}
                            <label class="form-check-label ms-1">Delete</label>
                          </div>
                          {% else %}
                          <button
                            type="button"
                            class="btn btn-danger btn-sm remove-attachment-row"
                          >
                            Remove
                          </button>
                          {% endif %}
                        </td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>

                <button
                  type="button"
                  id="addAttachmentRow"
                  class="btn btn-secondary btn-sm mt-2"
                >
                  Add More Files
                </button>

                <table style="display: none">
                  <tbody id="attach-empty-row">
                    <tr>
                      <td>{{ attachment_formset.empty_form.id }}</td>
                      <td>{{ attachment_formset.empty_form.file }}</td>
                      <td>
                        <button
                          type="button"
                          class="btn btn-danger btn-sm remove-attachment-row"
                        >
                          Remove
                        </button>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-outline-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button type="submit" class="btn btn-primary">Save All</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
<!-- Delete Modal -->
<div class="modal fade" id="delete_modal">
  <div class="modal-dialog modal-dialog-centered modal-sm">
    <div class="modal-content">
      <div class="modal-body text-center">
        <span class="avatar avatar-xl bg-transparent-danger text-danger mb-3">
          <i class="ti ti-trash-x fs-36"></i>
        </span>
        <h4 class="mb-1">Confirm Delete</h4>
        <p class="mb-3">
          You want to delete all the marked items, this cant be undone once you
          delete.
        </p>
        <div class="d-flex justify-content-center">
          <a
            href="javascript:void(0);"
            class="btn btn-light me-3"
            data-bs-dismiss="modal"
            >Cancel</a
          >
          <a
            href="https://smarthr.dreamstechnologies.com/html/template/companies.html"
            class="btn btn-danger"
            >Yes, Delete</a
          >
        </div>
      </div>
    </div>
  </div>
</div>
<!-- /Delete Modal -->
<form id="deleteEmployeeForm" method="POST" style="display: none">
  {% csrf_token %}
</form>





<!-- Template for attachment rows -->
<div id="attachment-empty-template" style="display:none;">
    <div class="row mb-2 attachment-row">
        <div class="col-6">
            <input type="file" class="form-control attachment-file">
        </div>
        <div class="col-4">
            <input type="text" class="form-control attachment-name" placeholder="Document Name">
        </div>
        <div class="col-2">
            <button type="button" class="btn btn-danger btn-sm remove-attachment">X</button>
        </div>
    </div>
</div>

<div class="modal fade" id="attachments_modal">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">Manage Previous Employment Attachments</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <div id="attachments_container"></div>

                <button type="button" id="add_attachment_btn" class="btn btn-secondary mt-2">Add Document</button>
            </div>

            <div class="modal-footer">
                <button type="button" id="save_attachments_btn" class="btn btn-success">Save</button>
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Close</button>
            </div>

        </div>
    </div>
</div>
<!--/ Responsive Datatable -->

<!-- JavaScript: add/remove rows using empty_form template and update TOTAL_FORMS -->
<script>
document.addEventListener("DOMContentLoaded", function () {

    /* -----------------------------
       PREVIOUS EMPLOYMENT DUPLICATE
    ------------------------------*/

    const prevTableBody = document.querySelector("#prevEmploymentTable tbody");
    const prevTotalForms = document.getElementById("id_previous_employments-TOTAL_FORMS");

    document.getElementById("addPrevRow").addEventListener("click", function () {

        let newIndex = parseInt(prevTotalForms.value);
        let template = document.querySelector("#prev-empty-row").innerHTML.replace(/__prefix__/g, newIndex);

        let temp = document.createElement("tbody");
        temp.innerHTML = template;

        let newRow = temp.querySelector("tr");

        // FIX: Add new Manage Documents button dynamically
        newRow.querySelector(".manage-documents").setAttribute("data-index", newIndex);

        prevTableBody.appendChild(newRow);
        prevTotalForms.value = newIndex + 1;
    });

    // Delete previous employment row
    prevTableBody.addEventListener("click", function (event) {
        if (event.target.classList.contains("remove-prev-row")) {
            event.target.closest("tr").remove();
            prevTotalForms.value = Math.max(0, parseInt(prevTotalForms.value) - 1);
        }
    });


    /* -----------------------------
       ATTACHMENT MODAL HANDLING
    ------------------------------*/

    let currentIndex = null;

    // Event delegation to handle dynamically added rows
    document.body.addEventListener("click", function(e) {

        if (e.target.classList.contains("manage-documents")) {

            currentIndex = e.target.dataset.index;

            const modal = new bootstrap.Modal(document.getElementById("attachments_modal"));
            const container = document.getElementById("attachments_container");
            container.innerHTML = "";

            // Load existing saved input rows
            document.querySelectorAll(`[data-row="${currentIndex}"]`).forEach(item => {
                container.appendChild(item.cloneNode(true));
            });

            modal.show();
        }
    });

    // Add new attachment row inside modal
    document.getElementById("add_attachment_btn").addEventListener("click", () => {
        document.getElementById("attachments_container")
            .insertAdjacentHTML("beforeend", document.getElementById("attachment-empty-template").innerHTML);
    });

    // Remove attachment row
    document.addEventListener("click", e => {
        if (e.target.classList.contains("remove-attachment")) {
            e.target.closest(".attachment-row").remove();
        }
    });

    // Save attachment rows back to the form before modal close
    document.getElementById("save_attachments_btn").addEventListener("click", () => {

        const container = document.getElementById("attachments_container");
        const rows = container.querySelectorAll(".attachment-row");

        // Remove previously saved rows for same entry
        document.querySelectorAll(`[data-row="${currentIndex}"]`).forEach(x => x.remove());

        const storage = document.getElementById("hidden-nested-files");

        rows.forEach((row, index) => {

            const fileInput = row.querySelector(".attachment-file");
            const nameValue = row.querySelector(".attachment-name").value;

            let block = document.createElement("div");
            block.dataset.row = currentIndex;

            // Rename input so backend detects it
            fileInput.name = `attach-${currentIndex}-${index}-file`;
            block.appendChild(fileInput);

            let hidden = document.createElement("input");
            hidden.type = "hidden";
            hidden.name = `attach-${currentIndex}-${index}-document_name`;
            hidden.value = nameValue;

            block.appendChild(hidden);

            storage.appendChild(block);
        });

        bootstrap.Modal.getInstance(document.getElementById("attachments_modal")).hide();
    });

}); 
</script>


<script>
  function confirmEmployeeDelete(employeeId) {
    Swal.fire({
      title: "Are you sure?",
      text: "This employee will be permanently deleted!",
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#d33",
      cancelButtonColor: "#3085d6",
      confirmButtonText: "Yes, delete!",
    }).then((result) => {
      if (result.isConfirmed) {
        const form = document.getElementById("deleteEmployeeForm");
        form.action = `/employee/delete/${employeeId}/`;
        form.submit();
      }
    });
  }
</script>
{% endblock %}
