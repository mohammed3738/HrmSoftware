{% extends 'base2.html' %}
{% block body %}

<div class="container-xxl flex-grow-1 container-p-y">

  <div class="card">
    <div class="card-body">

      <div class="d-flex justify-content-between mb-3">
        <h5 class="card-header">Salary Increments</h5>

<button type="button" class="btn btn-primary"
        data-bs-toggle="modal"
        data-bs-target="#incrementModal">
  ➕ New Increment
</button>
      </div>

      <!-- TABS -->
      <ul class="nav nav-tabs mb-4">
        <li class="nav-item">
          <a class="nav-link {% if active_tab == 'all' %}active{% endif %}"
             href="?status=all">All</a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if active_tab == 'pending' %}active{% endif %}"
             href="?status=pending">Pending</a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if active_tab == 'applied' %}active{% endif %}"
             href="?status=applied">Applied</a>
        </li>
      </ul>

      <!-- SEARCH & FILTER ROW -->
      <div class="row mb-3">
        <div class="col-md-4">
          <input type="text" id="searchBox" class="form-control"
            placeholder="Search employee, date, reason...">
        </div>

        <div class="col-md-3 d-flex align-items-center">
          <select id="statusFilter" class="form-select">
            <option value="all">All</option>
            <option value="pending">Pending</option>
            <option value="applied">Applied</option>
          </select>
        </div>

        <div class="col-md-3 d-flex align-items-center">
          <button class="btn btn-secondary" onclick="exportIncrements()">
            Export
          </button>
        </div>
      </div>

      <div class="table-responsive">
        <table class="table table-bordered text-center" id="incrementTable">

          <thead class="table-light">
            <tr>
              <th>Employee</th>
              <th>Effective Date</th>
              <th>Gross CTC (PM)</th>
              <th>Net Salary (PM)</th>
              <th>Reason</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>

          <tbody>
          {% for inc in increments %}
          <tr>
              <td>{{ inc.employee.first_name }} ({{ inc.employee.employee_code }})</td>
              <td>{{ inc.effective_date }}</td>

              <!-- Correct JSON keys -->
              <td>{{ inc.change_set.monthly.gross_ctc }}</td>
              <td>{{ inc.change_set.monthly.net_salary }}</td>

              <td>{{ inc.change_set.reason|default:"-" }}</td>

              <td>
                  {% if inc.is_processed %}
                      <span class="badge bg-success">Applied</span>
                  {% else %}
                      <span class="badge bg-warning text-dark">Pending</span>
                  {% endif %}
              </td>

              <td>
                  <button type="button" class="btn btn-sm btn-secondary"
                          onclick="viewIncrementDetails({{ inc.id }})">
                      <i class="ri-eye-line"></i>
                  </button>
              </td>
          </tr>
          {% endfor %}
          </tbody>

        </table>
      </div>

    </div>
  </div>





<!-- ========================================================= -->
<!--                    INCREMENT MODAL                       -->
<!-- ========================================================= -->

<div class="modal fade" id="incrementModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content salary-modal">

      <div class="modal-header salary-header">
        <h5 class="modal-title">Apply Salary Increment</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <form id="incrementForm" method="POST" action="{% url 'salary_increment' %}">
        {% csrf_token %}

        <div class="modal-body">
          <div class="row g-4">

            <!-- LEFT SIDE -->
            <div class="col-md-6">
              <div class="card h-100 border shadow-none">
                <div class="card-body">

                  <h6 class="fw-bold text-primary mb-3">Increment Details</h6>

                  <div class="mb-3">
                    <label class="form-label">Select Employee</label>
                    <select class="form-select" id="employeeSelect" name="employee" required>
                      <option value="">Select Employee</option>
                      {% for emp in employees %}
                      <option value="{{ emp.id }}">{{ emp.first_name }} ({{ emp.employee_code }})</option>
                      {% endfor %}
                    </select>
                  </div>

                  <div class="mb-3">
                    <label class="form-label">Effective Date <span class="text-danger">*</span></label>
                    <input type="date" class="form-control" name="effective_date" required>
                  </div>

                  <div class="mb-3">
                    <label class="form-label">Reason (Optional)</label>
                    <textarea class="form-control" name="reason" rows="2"></textarea>
                  </div>

                  <hr>

                  <h6 class="fw-bold text-primary mb-3">Enter Values</h6>

                  <div class="mb-3">
                    <label class="form-label">Gross CTC (Monthly)</label>
                    <input type="number" class="form-control" id="grossCTC" name="gross_ctc_pm" step="0.01" required>
                  </div>

                  <div class="row g-2">
                    <div class="col-md-6">
                      <label class="form-label">Allowance 1</label>
                      <input type="number" class="form-control" id="allowance1" name="allowance1_pm">
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Allowance 2</label>
                      <input type="number" class="form-control" id="allowance2" name="allowance2_pm">
                    </div>
                  </div>

                  <div class="mt-3">
                    <label class="form-label">Professional Tax</label>
                    <input type="number" class="form-control" id="profTax" name="profession_tax_pm">
                  </div>

                  <hr>

                  <div class="row g-2">
                    <div class="col-md-4">
                      <label class="form-label">Include PF?</label>
                      <select class="form-select" name="pf_deducted" id="pfSelect">
                        <option value="yes">Yes</option>
                        <option value="no">No</option>
                      </select>
                    </div>

                    <div class="col-md-4">
                      <label class="form-label">Include ESIC?</label>
                      <select class="form-select" id="esicSelect" name="esic_applicable">
                        <option value="yes">Yes</option>
                        <option value="no">No</option>
                      </select>
                    </div>

                    <div class="col-md-4">
                      <label class="form-label">Include Gratuity?</label>
                      <select class="form-select" name="gratuity_applicable" id="gratuitySelect">
                        <option value="yes">Yes</option>
                        <option value="no">No</option>
                      </select>
                    </div>
                  </div>

                </div>
              </div>
            </div>



            <!-- RIGHT SIDE (Breakdown) -->
            <div class="col-md-6">
              <div class="card h-100 border shadow-none">
                <div class="card-body">

                  <h6 class="fw-bold text-primary mb-3">Monthly Breakdown</h6>

                  <div class="row g-2">
                    <div class="col-md-6">
                      <label class="form-label">Basic</label>
                      <input type="number" id="basic" name="basic_pm" class="form-control editable-calc">
                    </div>

                    <div class="col-md-6">
                      <label class="form-label">HRA</label>
                      <input type="number" id="hra" name="hra_pm" class="form-control editable-calc">
                    </div>

                    <div class="col-md-6">
                      <label class="form-label">Stat Bonus</label>
                      <input type="number" id="statBonus" name="stat_bonus_pm" class="form-control editable-calc">
                    </div>

                    <div class="col-md-6">
                      <label class="form-label">Special Allowance</label>
                      <input type="number" id="specialAllowance" name="sp_allowance_pm" class="form-control editable-calc">
                    </div>

                    <div class="col-md-6">
                      <label class="form-label">Guaranteed Cash</label>
                      <input type="number" id="guaranteedCash" name="guaranteed_cash_pm" class="form-control" readonly>
                    </div>

                    <div class="col-md-6">
                      <label class="form-label">PF Employer</label>
                      <input type="number" id="pfEr" name="pf_er_cont_pm" class="form-control editable-calc">
                    </div>

                    <div class="col-md-6">
                      <label class="form-label">PF Employee</label>
                      <input type="number" id="pfEe" name="pf_ee_cont_pm" class="form-control" readonly>
                    </div>

                    <div class="col-md-6">
                      <label class="form-label">ESIC Employer</label>
                      <input type="number" id="esicEr" name="esic_er_cont_pm" class="form-control editable-calc">
                    </div>

                    <div class="col-md-6">
                      <label class="form-label">ESIC Employee</label>
                      <input type="number" id="esicEe" name="esic_ee_cont_pm" class="form-control editable-calc">
                    </div>

                    <div class="col-md-6">
                      <label class="form-label">Gratuity</label>
                      <input type="number" id="gratuity" name="gratuity_pm" class="form-control editable-calc">
                    </div>

                    <div class="col-md-6">
                      <label class="form-label">CTC</label>
                      <input type="number" id="costToCompany" name="ctc_pm" class="form-control" readonly>
                    </div>

                    <div class="col-md-6">
                      <label class="form-label">Net Salary</label>
                      <input type="number" id="netSalary" name="net_salary_pm" class="form-control fw-bold text-success editable-calc">
                    </div>

                  </div>

                </div>
              </div>
            </div>


            <!-- ANNUAL SECTION (same as SalaryMaster) -->
            <div class="col-12 mt-3">
              <div class="card shadow-none">
                <div class="card-header bg-light d-flex justify-content-between">
                  <h6 class="fw-bold text-primary mb-0">Annual Figures</h6>
                  <button class="btn btn-sm btn-outline-primary" data-bs-toggle="collapse" data-bs-target="#annualCollapse">
                    <i class="ri-arrow-down-s-line"></i> Toggle
                  </button>
                </div>

                <div id="annualCollapse" class="collapse">
                  <div class="card-body">
                    <div class="row g-3 mt-4">

                      <div class="col-md-3"><label>Gross CTC</label><input type="number" id="grossCTCAnn" name="gross_ctc_pa" class="form-control" readonly></div>
                      <div class="col-md-3"><label>Basic</label><input type="number" id="basicAnn" name="basic_pa" class="form-control" readonly></div>
                      <div class="col-md-3"><label>HRA</label><input type="number" id="hraAnn" name="hra_pa" class="form-control" readonly></div>
                      <div class="col-md-3"><label>Stat Bonus</label><input type="number" id="statBonusAnn" name="stat_bonus_pa" class="form-control" readonly></div>
                      <div class="col-md-3"><label>Prof Tax</label><input type="number" id="profTaxAnn" name="profession_tax_pa" class="form-control" readonly></div>
                      <div class="col-md-3"><label>Special Allowance</label><input type="number" id="specialAllowanceAnn" name="sp_allowance_pa" class="form-control" readonly></div>
                      <div class="col-md-3"><label>Allowance 1</label><input type="number" id="allowance1Ann" name="allowance1_pa" class="form-control" readonly></div>
                      <div class="col-md-3"><label>Allowance 2</label><input type="number" id="allowance2Ann" name="allowance2_pa" class="form-control" readonly></div>
                      <div class="col-md-3"><label>Guaranteed Cash</label><input type="number" id="guaranteedCashAnn" name="guaranteed_cash_pa" class="form-control" readonly></div>
                      <div class="col-md-3"><label>PF Employer</label><input type="number" id="pfErAnn" name="pf_er_cont_pa" class="form-control" readonly></div>
                      <div class="col-md-3"><label>ESIC Employer</label><input type="number" id="esicErAnn" name="esic_er_cont_pa" class="form-control" readonly></div>
                      <div class="col-md-3"><label>PF Employee</label><input type="number" id="pfEeAnn" name="pf_ee_cont_pa" class="form-control" readonly></div>
                      <div class="col-md-3"><label>ESIC Employee</label><input type="number" id="esicEeAnn" name="esic_ee_cont_pa" class="form-control" readonly></div>
                      <div class="col-md-3"><label>CTC</label><input type="number" id="costToCompanyAnn" name="ctc_pa" class="form-control" readonly></div>
                      <div class="col-md-3"><label>Net Salary</label><input type="number" id="netSalaryAnn" name="net_salary_pa" class="form-control fw-bold text-success" readonly></div>

                    </div>
                  </div>
                </div>
              </div>
            </div>


          </div> <!-- row -->
        </div> <!-- modal body -->

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-success">Save Increment</button>
        </div>

      </form>

    </div>
  </div>
</div>






<div class="modal fade" id="incrementDetailsModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">Increment Details</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body" id="incrementDetailsBody">
        <div class="text-center py-3">
          <i class="ri-loader-4-line ri-spin"></i> Loading...
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>



<!-- =========================== -->
<!--  USE SAME JS FROM SalaryMaster  -->
<!-- =========================== -->

<!-- ===== JS SCRIPT ===== -->
<script>
/* -------------------------------
   Final JS — Option B (Basic edits recalc HRA)
   Paste/replace your previous calculator script with this
   ------------------------------- */

let payrollSettings = {
    pf_percentage: 0,
    esic_percentage: 0,
    gratuity_percentage: 0,
    professional_tax: 0,
    bonus_percentage: 0,
    basic_percentage: 0,
    hra_percentage: 0,
    basic_cap: 0,
};

async function loadPayrollSettings() {
    try {
        const res = await fetch('/payroll-settings/');
        payrollSettings = await res.json();
        // Init calculation if modal is open/fields present
        calculateIncrementSalary();
    } catch (err) {
        console.error('Failed to load payroll settings', err);
    }
}

/* Utility helpers */
const $ = id => document.getElementById(id);
const val = id => parseFloat($(id)?.value || 0);
const round = v => Math.round(v);
const setIfExists = (id, value) => { if ($(id)) $(id).value = round(value); };

/* Mark manual override when user types */
function markManual(e) {
    e.target.dataset.manual = "true";
}

/* Clear manual flag (used when system should control a field) */
function clearManualFlag(id) {
    const el = $(id);
    if (el) {
        el.dataset.manual = "false";
        el.classList.remove('border-warning');
    }
}

/* Apply 'manual style' for UX when user manually edits */
function applyManualStyle(el) {
    if (!el) return;
    el.dataset.manual = "true";
    el.classList.add('border-warning');
}

/* ----------------------------------------------------
   Main calculator — respects manual overrides.
   Option B behaviour:
     - When Basic is edited: HRA recalculated = basic * hraPerc (overwrites HRA unless user already manually edited HRA afterwards)
     - Other fields can be manually edited.
   ---------------------------------------------------- */
function calculateIncrementSalary(triggeredById) {
    // Basic validation
    const grossCTC = val('grossCTC');
    if (!grossCTC || grossCTC <= 0) {
        // clear outputs
        ['basic','hra','statBonus','specialAllowance','pfEr','pfEe','esicEr','esicEe','gratuity','guaranteedCash','costToCompany','netSalary',
         'grossCTCAnn','basicAnn','hraAnn','statBonusAnn','allowance1Ann','allowance2Ann','specialAllowanceAnn','guaranteedCashAnn',
         'pfErAnn','pfEeAnn','esicErAnn','esicEeAnn','gratuityAnn','profTaxAnn','costToCompanyAnn','netSalaryAnn'].forEach(id => {
            if ($(id)) $(id).value = '';
         });
        return;
    }

    // Inputs
    const allowance1 = val('allowance1');
    const allowance2 = val('allowance2');

    // Payroll settings (with safe defaults)
    const basicPerc = (payrollSettings.basic_percentage || 0) / 100;
    const hraPerc = (payrollSettings.hra_percentage || 0) / 100;
    const pfPerc = (payrollSettings.pf_percentage || 0) / 100;
    const esicPerc = (payrollSettings.esic_percentage || 0) / 100;
    const gratuityPerc = (payrollSettings.gratuity_percentage || 0) / 100;
    const bonusPerc = (payrollSettings.bonus_percentage || 0) / 100;
    const basicCap = payrollSettings.basic_cap || 0;

    // Professional tax: prefer manual override input (profTax field), otherwise payroll setting
    let profTax = val('profTax');
    if (!profTax) profTax = payrollSettings.professional_tax || 0;

    // toggles
    const pfEnabled = $('pfSelect')?.value === 'yes';
    const esicEnabled = $('esicSelect')?.value === 'yes';
    const gratuityEnabled = $('gratuitySelect')?.value === 'yes';

    /* ----------------------
       1) Basic: system default vs manual
       - If user edited 'basic' (data-manual === "true") we use that.
       - Otherwise system compute defaultBasic = min(grossCTC*basicPerc, basicCap)
       However Option B: if user edits basic, HRA will be recalculated from basic.
       ---------------------- */
    const basicEl = $('basic');
    let basicSys = Math.min(grossCTC * basicPerc, basicCap);
    let basicVal = basicSys;

    if (basicEl && basicEl.dataset.manual === "true") {
        // user entered basic manually -> use it (still respect rounding)
        basicVal = round(parseFloat(basicEl.value) || basicSys);
    } else {
        // system value (rounded)
        basicVal = round(basicSys);
    }

    // If the trigger was manual typing into 'basic', ensure basicEl reflects rounded value and mark it manual
    if (triggeredById === 'basic' && basicEl) {
        basicEl.value = basicVal;
        applyManualStyle(basicEl); // keep manual flag
    }

    /* ----------------------
       2) HRA: Option B rules
       - If Basic changed (triggeredById === 'basic'), HRA recalculated as basicVal * hraPerc and system-controlled (overwrite unless user manually changed HRA after).
       - If HRA has been manually edited by user (data-manual === "true") and the trigger wasn't 'basic', keep manual.
       - If HRA not manual and trigger != 'basic', system compute from basicVal.
       ---------------------- */
    const hraEl = $('hra');
    let hraValSys = round(basicVal * hraPerc);

    if (triggeredById === 'basic') {
        // force recalc and clear manual flag on HRA (system-controlled now)
        if (hraEl) {
            hraEl.value = hraValSys;
            clearManualFlag('hra');
        }
    }

    let hraVal;
    if (hraEl && hraEl.dataset.manual === "true") {
        hraVal = round(parseFloat(hraEl.value) || hraValSys);
    } else {
        hraVal = hraValSys;
        if (hraEl) hraEl.value = hraVal;
    }

    /* ----------------------
       3) Stat Bonus (system default or manual)
       Excel rule: if basic < 21000 then statBonus = ROUND(7000 * bonusPerc, 0) else 0
       ---------------------- */
    const statEl = $('statBonus');
    let statSys = (basicVal < 21000) ? Math.round(7000 * bonusPerc) : 0;
    let statVal = statSys;
    if (statEl && statEl.dataset.manual === "true") {
        statVal = round(parseFloat(statEl.value) || statSys);
    } else {
        if (statEl) statEl.value = statVal;
    }

    /* ----------------------
       4) PF Employer / Employee
       - PF ER = min(basic * pfPerc, 1800) if enabled
       - PF EE = PF ER
       - PF fields are editable: if user manually changed pfEr, respect it (but ensure pfEe = pfEr)
       ---------------------- */
    const pfErEl = $('pfEr');
    let pfErSys = pfEnabled ? Math.min(basicVal * pfPerc, 1800) : 0;
    let pfErVal = pfErSys;
    if (pfErEl && pfErEl.dataset.manual === "true") {
        pfErVal = round(parseFloat(pfErEl.value) || pfErSys);
    } else {
        if (pfErEl) pfErEl.value = round(pfErVal);
    }
    // PF Employee mirrors pfErVal
    const pfEeEl = $('pfEe');
    if (pfEeEl) pfEeEl.value = round(pfErVal);

    /* ----------------------
       5) Gratuity
       ---------------------- */
    const gratuityEl = $('gratuity');
    let gratuitySys = gratuityEnabled ? Math.round(basicVal * gratuityPerc) : 0;
    let gratuityVal = gratuitySys;
    if (gratuityEl && gratuityEl.dataset.manual === "true") {
        gratuityVal = round(parseFloat(gratuityEl.value) || gratuitySys);
    } else {
        if (gratuityEl) gratuityEl.value = gratuityVal;
    }

    /* ----------------------
       6) TEMP guaranteed to decide ESIC:
       Excel behaviour: compute guaranteed cash *before* ESIC, then if <=21000 compute ESIC on that GC.
       We'll replicate: calculate temporary specialAllowance (assuming ESIC=0) to compute temp guaranteed, then ESIC uses that temp guaranteed.
       ---------------------- */
    // Determine temporary special allowance (assuming ESIC 0)
    let specialTemp = grossCTC - (basicVal + hraVal + statVal + allowance1 + allowance2 + pfErVal + 0 + gratuityVal);
    let guaranteedTemp = basicVal + hraVal + statVal + allowance1 + allowance2 + specialTemp;

    // ESIC calculation
    const esicErEl = $('esicEr');
    let esicErVal = 0;
    if (esicEnabled && guaranteedTemp <= 21000) {
        esicErVal = Math.round(guaranteedTemp * esicPerc);
    }
    // If user manually edited esicEr, respect that (but ensure esicEe = esicEr)
    if (esicErEl && esicErEl.dataset.manual === "true") {
        esicErVal = round(parseFloat(esicErEl.value) || esicErVal);
    } else {
        if (esicErEl) esicErEl.value = esicErVal;
    }
    if ($('esicEe')) $('esicEe').value = esicErVal;

    /* ----------------------
       7) Final Special Allowance (balancing figure EXACT to Excel)
       SA = grossCTC - (basic + hra + statBonus + allowance1 + allowance2 + pfEr + esicEr + gratuity)
       If user manually edited SA, respect it; otherwise set this balancing figure.
       ---------------------- */
    const specialEl = $('specialAllowance');
    let specialSys = round(grossCTC - (basicVal + hraVal + statVal + allowance1 + allowance2 + pfErVal + esicErVal + gratuityVal));
    let specialVal = specialSys;
    if (specialEl && specialEl.dataset.manual === "true") {
        specialVal = round(parseFloat(specialEl.value) || specialSys);
    } else {
        if (specialEl) specialEl.value = specialVal;
    }

    /* ----------------------
       8) Guaranteed Cash final
       ---------------------- */
    let guaranteedCash = basicVal + hraVal + statVal + allowance1 + allowance2 + specialVal;

    /* ----------------------
       9) Net Salary
       - net = guaranteedCash - PF Employee - ESIC Employee - profTax
       If user manually edited netSalary, respect it; otherwise compute.
       ---------------------- */
    const netEl = $('netSalary');
    let netSys = guaranteedCash - pfErVal - esicErVal - profTax;
    let netVal = netSys;
    if (netEl && netEl.dataset.manual === "true") {
        netVal = round(parseFloat(netEl.value) || netSys);
    } else {
        if (netEl) netEl.value = round(netVal);
    }

    /* ----------------------
       10) CTC final
       ---------------------- */
    let ctc = guaranteedCash + pfErVal + esicErVal + gratuityVal;

    /* ----------------------
       Write-back rounded monthly values (for fields not manually edited we've already written above; ensure all exist)
       ---------------------- */
    setIfExists('basic', basicVal);
    setIfExists('hra', hraVal);
    setIfExists('statBonus', statVal);
    setIfExists('specialAllowance', specialVal);
    setIfExists('pfEr', pfErVal);
    setIfExists('pfEe', pfErVal);
    setIfExists('esicEr', esicErVal);
    setIfExists('esicEe', esicErVal);
    setIfExists('gratuity', gratuityVal);
    setIfExists('guaranteedCash', guaranteedCash);
    setIfExists('costToCompany', ctc);
    setIfExists('netSalary', netVal);

    /* ----------------------
       Annual fields (rounded)
       ---------------------- */
    setIfExists('grossCTCAnn', grossCTC * 12);
    setIfExists('basicAnn', basicVal * 12);
    setIfExists('hraAnn', hraVal * 12);
    setIfExists('statBonusAnn', statVal * 12);
    setIfExists('allowance1Ann', allowance1 * 12);
    setIfExists('allowance2Ann', allowance2 * 12);
    setIfExists('specialAllowanceAnn', specialVal * 12);
    setIfExists('guaranteedCashAnn', guaranteedCash * 12);
    setIfExists('pfErAnn', pfErVal * 12);
    setIfExists('pfEeAnn', pfErVal * 12);
    setIfExists('esicErAnn', esicErVal * 12);
    setIfExists('esicEeAnn', esicErVal * 12);
    setIfExists('gratuityAnn', gratuityVal * 12);
    setIfExists('profTaxAnn', profTax * 12);
    setIfExists('costToCompanyAnn', ctc * 12);
    setIfExists('netSalaryAnn', netVal * 12);
}

/* --------------------------------------------------------
   Attach events: inputs become manual on user edit.
   Special behaviour:
     - basic input will trigger calculateIncrementSalary('basic') so HRA recalculates per option B.
     - other inputs mark manual and trigger recalculation.
   -------------------------------------------------------- */
document.addEventListener('DOMContentLoaded', () => {
    loadPayrollSettings();

    // fields inside increment modal we care about
    const watched = [
        'grossCTC','allowance1','allowance2','profTax',
        'basic','hra','statBonus','specialAllowance',
        'pfEr','esicEr','gratuity','netSalary',
        'pfSelect','esicSelect','gratuitySelect'
    ];

    watched.forEach(id => {
        const el = $(id);
        if (!el) return;
        // For selects and numbers use change + input
        el.addEventListener('input', (e) => {
            // For basic: mark manual but indicate it triggered by basic
            if (id === 'basic') {
                applyManualStyle(el); // basic is user-entered
                calculateIncrementSalary('basic');
            } else {
                // mark manual override for all other direct user edits (so JS will respect them)
                applyManualStyle(el);
                calculateIncrementSalary(id);
            }
        });
        el.addEventListener('change', (e) => {
            if (id === 'basic') {
                applyManualStyle(el);
                calculateIncrementSalary('basic');
            } else {
                applyManualStyle(el);
                calculateIncrementSalary(id);
            }
        });
    });

    // also attach calculation to any selects inside modal (pf, esic, gratuity)
    ['pfSelect','esicSelect','gratuitySelect'].forEach(id => {
        const s = $(id);
        if (!s) return;
        s.addEventListener('change', () => calculateIncrementSalary(id));
    });

    // initial run
    calculateIncrementSalary();
});

/* --------------------------------------------------------
 * INCREMENT DETAILS MODAL LOADER
 * -------------------------------------------------------- */
async function viewIncrementDetails(id) {
    const modalBody = document.getElementById("incrementDetailsBody");

    modalBody.innerHTML = `<div class="text-center py-3"><i class="ri-loader-4-line ri-spin"></i> Loading...</div>`;
    new bootstrap.Modal(document.getElementById("incrementDetailsModal")).show();

    try {
        const res = await fetch(`/salary/increment/details/${id}/`);
        const data = await res.json();

        modalBody.innerHTML = `
            <table class="table table-bordered table-sm">
                <tr><th>Employee</th><td>${data.employee}</td></tr>
                <tr><th>Effective Date</th><td>${data.effective_date}</td></tr>
                <tr><th>Gross CTC (PM)</th><td>${data.gross_ctc_pm}</td></tr>
                <tr><th>Net Salary (PM)</th><td>${data.net_salary_pm}</td></tr>

                <tr><th>PF</th><td>${data.flags.pf_deducted ? "Yes" : "No"}</td></tr>
                <tr><th>ESIC</th><td>${data.flags.esic_applicable ? "Yes" : "No"}</td></tr>
                <tr><th>Gratuity</th><td>${data.flags.gratuity_applicable ? "Yes" : "No"}</td></tr>

                <tr><th>Status</th>
                    <td>${data.is_processed ?
                        "<span class='badge bg-success'>Applied</span>" :
                        "<span class='badge bg-warning text-dark'>Pending</span>"}
                    </td>
                </tr>
            </table>
        `;
    } catch (err) {
        modalBody.innerHTML = `<div class="alert alert-danger">Failed to load details.</div>`;
    }
}
</script>
{% endblock %}
