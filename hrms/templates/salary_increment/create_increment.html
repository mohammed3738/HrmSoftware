{% extends 'base2.html' %}
{% block body %}

<div class="container-xxl flex-grow-1 container-p-y">

  <div class="card">
    <div class="card-body">

      <div class="d-flex justify-content-between mb-3">
        <h5 class="card-header">Salary Increments</h5>

<button type="button" class="btn btn-primary"
        data-bs-toggle="modal"
        data-bs-target="#incrementModal">
  ‚ûï New Increment
</button>
      </div>

      <!-- TABS -->
      <ul class="nav nav-tabs mb-4">
        <li class="nav-item">
          <a class="nav-link {% if active_tab == 'all' %}active{% endif %}"
             href="?status=all">All</a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if active_tab == 'pending' %}active{% endif %}"
             href="?status=pending">Pending</a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if active_tab == 'applied' %}active{% endif %}"
             href="?status=applied">Applied</a>
        </li>
      </ul>

      <!-- SEARCH & FILTER ROW -->
      <div class="row mb-3">
        <div class="col-md-4">
          <input type="text" id="searchBox" class="form-control"
            placeholder="Search employee, date, reason...">
        </div>

        <div class="col-md-3 d-flex align-items-center">
          <select id="statusFilter" class="form-select">
            <option value="all">All</option>
            <option value="pending">Pending</option>
            <option value="applied">Applied</option>
          </select>
        </div>

        <div class="col-md-3 d-flex align-items-center">
          <button class="btn btn-secondary" onclick="exportIncrements()">
            Export
          </button>
        </div>
      </div>

      <div class="table-responsive">
        <table class="table table-bordered text-center" id="incrementTable">

          <thead class="table-light">
            <tr>
              <th>Employee</th>
              <th>Effective Date</th>
              <th>Gross CTC (PM)</th>
              <th>Net Salary (PM)</th>
              <th>Reason</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>

          <tbody>
            {% for inc in increments %}
            <tr>
              <td>{{ inc.employee.first_name }} ({{ inc.employee.employee_code }})</td>
              <td>{{ inc.effective_date }}</td>
              <td>{{ inc.gross_ctc_pm }}</td>
              <td>{{ inc.net_salary_pm }}</td>
              <td>{{ inc.reason|default:"-" }}</td>

              <td>
                {% if inc.is_processed %}
                  <span class="badge bg-success">Applied</span>
                {% else %}
                  <span class="badge bg-warning text-dark">Pending</span>
                {% endif %}
              </td>

              <td>
                <button type="button" class="btn btn-sm btn-secondary"
                        onclick="viewIncrementDetails({{ inc.id }})">
                  <i class="ri-eye-line"></i>
                </button>
              </td>
            </tr>
            {% endfor %}
          </tbody>

        </table>
      </div>

    </div>
  </div>





<!-- ========================================================= -->
<!--                    INCREMENT MODAL                       -->
<!-- ========================================================= -->

<div class="modal fade" id="incrementModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content salary-modal">

      <div class="modal-header salary-header">
        <h5 class="modal-title">Apply Salary Increment</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <form id="incrementForm" method="POST">
        {% csrf_token %}

        <div class="modal-body">
          <div class="row g-4">

            <!-- LEFT SIDE -->
            <div class="col-md-6">
              <div class="card h-100 border shadow-none">
                <div class="card-body">

                  <h6 class="fw-bold text-primary mb-3">Increment Details</h6>

                  <div class="mb-3">
                    <label class="form-label">Select Employee</label>
                    <select class="form-select" id="employeeSelect" name="employee" required>
                      <option value="">Select Employee</option>
                      {% for emp in employees %}
                      <option value="{{ emp.id }}">{{ emp.first_name }} ({{ emp.employee_code }})</option>
                      {% endfor %}
                    </select>
                  </div>

                  <div class="mb-3">
                    <label class="form-label">Effective Date <span class="text-danger">*</span></label>
                    <input type="date" class="form-control" name="effective_date" required>
                  </div>

                  <div class="mb-3">
                    <label class="form-label">Reason (Optional)</label>
                    <textarea class="form-control" name="reason" rows="2"></textarea>
                  </div>

                  <hr>

                  <h6 class="fw-bold text-primary mb-3">Enter Values</h6>

                  <div class="mb-3">
                    <label class="form-label">Gross CTC (Monthly)</label>
                    <input type="number" class="form-control" id="grossCTC" name="gross_ctc_pm" step="0.01" required>
                  </div>

                  <div class="row g-2">
                    <div class="col-md-6">
                      <label class="form-label">Allowance 1</label>
                      <input type="number" class="form-control" id="allowance1" name="allowance1_pm">
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Allowance 2</label>
                      <input type="number" class="form-control" id="allowance2" name="allowance2_pm">
                    </div>
                  </div>

                  <div class="mt-3">
                    <label class="form-label">Professional Tax</label>
                    <input type="number" class="form-control" id="profTax" name="profession_tax_pm">
                  </div>

                  <hr>

                  <div class="row g-2">
                    <div class="col-md-4">
                      <label class="form-label">Include PF?</label>
                      <select class="form-select" name="pf_deducted" id="pfSelect">
                        <option value="yes">Yes</option>
                        <option value="no">No</option>
                      </select>
                    </div>

                    <div class="col-md-4">
                      <label class="form-label">Include ESIC?</label>
                      <select class="form-select" id="esicSelect" name="esic_applicable">
                        <option value="yes">Yes</option>
                        <option value="no">No</option>
                      </select>
                    </div>

                    <div class="col-md-4">
                      <label class="form-label">Include Gratuity?</label>
                      <select class="form-select" name="gratuity_applicable" id="gratuitySelect">
                        <option value="yes">Yes</option>
                        <option value="no">No</option>
                      </select>
                    </div>
                  </div>

                </div>
              </div>
            </div>



            <!-- RIGHT SIDE (Breakdown) -->
            <div class="col-md-6">
              <div class="card h-100 border shadow-none">
                <div class="card-body">

                  <h6 class="fw-bold text-primary mb-3">Monthly Breakdown</h6>

                  <div class="row g-2">
                    <div class="col-md-6">
                      <label class="form-label">Basic</label>
                      <input type="number" id="basic" name="basic_pm" class="form-control editable-calc">
                    </div>

                    <div class="col-md-6">
                      <label class="form-label">HRA</label>
                      <input type="number" id="hra" name="hra_pm" class="form-control editable-calc">
                    </div>

                    <div class="col-md-6">
                      <label class="form-label">Stat Bonus</label>
                      <input type="number" id="statBonus" name="stat_bonus_pm" class="form-control editable-calc">
                    </div>

                    <div class="col-md-6">
                      <label class="form-label">Special Allowance</label>
                      <input type="number" id="specialAllowance" name="sp_allowance_pm" class="form-control editable-calc">
                    </div>

                    <div class="col-md-6">
                      <label class="form-label">Guaranteed Cash</label>
                      <input type="number" id="guaranteedCash" name="guaranteed_cash_pm" class="form-control" readonly>
                    </div>

                    <div class="col-md-6">
                      <label class="form-label">PF Employer</label>
                      <input type="number" id="pfEr" name="pf_er_cont_pm" class="form-control editable-calc">
                    </div>

                    <div class="col-md-6">
                      <label class="form-label">PF Employee</label>
                      <input type="number" id="pfEe" name="pf_ee_cont_pm" class="form-control" readonly>
                    </div>

                    <div class="col-md-6">
                      <label class="form-label">ESIC Employer</label>
                      <input type="number" id="esicEr" name="esic_er_cont_pm" class="form-control editable-calc">
                    </div>

                    <div class="col-md-6">
                      <label class="form-label">ESIC Employee</label>
                      <input type="number" id="esicEe" name="esic_ee_cont_pm" class="form-control editable-calc">
                    </div>

                    <div class="col-md-6">
                      <label class="form-label">Gratuity</label>
                      <input type="number" id="gratuity" name="gratuity_pm" class="form-control editable-calc">
                    </div>

                    <div class="col-md-6">
                      <label class="form-label">CTC</label>
                      <input type="number" id="costToCompany" name="ctc_pm" class="form-control" readonly>
                    </div>

                    <div class="col-md-6">
                      <label class="form-label">Net Salary</label>
                      <input type="number" id="netSalary" name="net_salary_pm" class="form-control fw-bold text-success editable-calc">
                    </div>

                  </div>

                </div>
              </div>
            </div>


            <!-- ANNUAL SECTION (same as SalaryMaster) -->
            <div class="col-12 mt-3">
              <div class="card shadow-none">
                <div class="card-header bg-light d-flex justify-content-between">
                  <h6 class="fw-bold text-primary mb-0">Annual Figures</h6>
                  <button class="btn btn-sm btn-outline-primary" data-bs-toggle="collapse" data-bs-target="#annualCollapse">
                    <i class="ri-arrow-down-s-line"></i> Toggle
                  </button>
                </div>

                <div id="annualCollapse" class="collapse">
                  <div class="card-body">
                    <div class="row g-3 mt-4">

                      <div class="col-md-3"><label>Gross CTC</label><input type="number" id="grossCTCAnn" name="gross_ctc_pa" class="form-control" readonly></div>
                      <div class="col-md-3"><label>Basic</label><input type="number" id="basicAnn" name="basic_pa" class="form-control" readonly></div>
                      <div class="col-md-3"><label>HRA</label><input type="number" id="hraAnn" name="hra_pa" class="form-control" readonly></div>
                      <div class="col-md-3"><label>Stat Bonus</label><input type="number" id="statBonusAnn" name="stat_bonus_pa" class="form-control" readonly></div>
                      <div class="col-md-3"><label>Prof Tax</label><input type="number" id="profTaxAnn" name="profession_tax_pa" class="form-control" readonly></div>
                      <div class="col-md-3"><label>Special Allowance</label><input type="number" id="specialAllowanceAnn" name="sp_allowance_pa" class="form-control" readonly></div>
                      <div class="col-md-3"><label>Allowance 1</label><input type="number" id="allowance1Ann" name="allowance1_pa" class="form-control" readonly></div>
                      <div class="col-md-3"><label>Allowance 2</label><input type="number" id="allowance2Ann" name="allowance2_pa" class="form-control" readonly></div>
                      <div class="col-md-3"><label>Guaranteed Cash</label><input type="number" id="guaranteedCashAnn" name="guaranteed_cash_pa" class="form-control" readonly></div>
                      <div class="col-md-3"><label>PF Employer</label><input type="number" id="pfErAnn" name="pf_er_cont_pa" class="form-control" readonly></div>
                      <div class="col-md-3"><label>ESIC Employer</label><input type="number" id="esicErAnn" name="esic_er_cont_pa" class="form-control" readonly></div>
                      <div class="col-md-3"><label>PF Employee</label><input type="number" id="pfEeAnn" name="pf_ee_cont_pa" class="form-control" readonly></div>
                      <div class="col-md-3"><label>ESIC Employee</label><input type="number" id="esicEeAnn" name="esic_ee_cont_pa" class="form-control" readonly></div>
                      <div class="col-md-3"><label>CTC</label><input type="number" id="costToCompanyAnn" name="ctc_pa" class="form-control" readonly></div>
                      <div class="col-md-3"><label>Net Salary</label><input type="number" id="netSalaryAnn" name="net_salary_pa" class="form-control fw-bold text-success" readonly></div>

                    </div>
                  </div>
                </div>
              </div>
            </div>


          </div> <!-- row -->
        </div> <!-- modal body -->

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-success">Save Increment</button>
        </div>

      </form>

    </div>
  </div>
</div>






<div class="modal fade" id="incrementDetailsModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">Increment Details</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body" id="incrementDetailsBody">
        <div class="text-center py-3">
          <i class="ri-loader-4-line ri-spin"></i> Loading...
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>



<!-- =========================== -->
<!--  USE SAME JS FROM SalaryMaster  -->
<!-- =========================== -->

<!-- ===== JS SCRIPT ===== -->
<script>
/* --------------------------------------------------------
 * CLEAN PAYROLL SETTINGS LOADER
 * -------------------------------------------------------- */
let payrollSettings = {
    pf_percentage: 0,
    esic_percentage: 0,
    gratuity_percentage: 0,
    professional_tax: 0,
    bonus_percentage: 0,
    basic_percentage: 0,
    hra_percentage: 0,
    basic_cap: 0,
};

async function loadPayrollSettings() {
    try {
        const res = await fetch("/payroll-settings/");
        payrollSettings = await res.json();
        calculateIncrementSalary();
    } catch (err) {
        console.error("‚ö† Failed to load payroll settings.");
    }
}

/* --------------------------------------------------------
 * TRUE EXCEL-MATCHED SALARY CALCULATOR
 * -------------------------------------------------------- */
function calculateIncrementSalary() {

    const get = id => parseFloat(document.getElementById(id)?.value || 0);

    // Inputs
    let grossCTC = get("grossCTC");
    let allowance1 = get("allowance1");
    let allowance2 = get("allowance2");

    // Payroll Settings
    let basicPerc = payrollSettings.basic_percentage / 100;       // 50%
    let hraPerc = payrollSettings.hra_percentage / 100;           // 60%
    let pfPerc = payrollSettings.pf_percentage / 100;             // 12%
    let esicPerc = payrollSettings.esic_percentage / 100;         // 3.67%
    let gratuityPerc = payrollSettings.gratuity_percentage / 100; // 4.61%
    let bonusPerc = payrollSettings.bonus_percentage / 100;       // 8.33%
    let basicCap = payrollSettings.basic_cap;                     // 21000
    let profTax = payrollSettings.professional_tax;               // 200

    // Selections
    let pfEnabled = document.getElementById("pfSelect").value === "yes";
    let esicEnabled = document.getElementById("esicSelect").value === "yes";
    let gratuityEnabled = document.getElementById("gratuitySelect").value === "yes";

    /* --------------------------------------------------------
     * 1Ô∏è‚É£ BASIC & HRA
     * -------------------------------------------------------- */
    let basic = Math.min(grossCTC * basicPerc, basicCap);
    let hra = basic * hraPerc;

    /* --------------------------------------------------------
     * 2Ô∏è‚É£ STAT BONUS ‚Äî only when basic < 21,000
     * -------------------------------------------------------- */
    let statBonus = 0;
    if (basic < 21000) {
        statBonus = Math.round(7000 * bonusPerc);
    }

    /* --------------------------------------------------------
     * 3Ô∏è‚É£ PF (ER = EE)
     * -------------------------------------------------------- */
    let pfEr = pfEnabled ? Math.min(basic * pfPerc, 1800) : 0;
    let pfEe = pfEr;

    /* --------------------------------------------------------
     * 4Ô∏è‚É£ GRATUITY
     * -------------------------------------------------------- */
    let gratuity = gratuityEnabled ? basic * gratuityPerc : 0;

    /* --------------------------------------------------------
     * 5Ô∏è‚É£ TEMP GC ‚Äî FOR ESIC CHECK
     * Excel calculates ESIC using Guaranteed Cash BEFORE ESIC
     * -------------------------------------------------------- */

    // First assume ESIC = 0 to get initial GC
    let specialTemp =
        grossCTC -
        (basic + hra + statBonus +
         allowance1 + allowance2 +
         pfEr + 0 + gratuity);

    let guaranteedTemp =
        basic + hra + statBonus + allowance1 + allowance2 + specialTemp;

    /* --------------------------------------------------------
     * 6Ô∏è‚É£ ESIC ‚Äî Excel: If GuaranteedCash <= 21,000 ‚Üí 3.67%
     * -------------------------------------------------------- */
    let esicEr = 0;
    let esicEe = 0;

    if (esicEnabled && guaranteedTemp <= 21000) {
        esicEr = guaranteedTemp * esicPerc;
        esicEe = esicEr;
    }

    /* --------------------------------------------------------
     * 7Ô∏è‚É£ FINAL SPECIAL ALLOWANCE (BALANCING FIGURE)
     * EXACT EXCEL FORMULA:
     * SA = GrossCTC - (Basic + HRA + StatBonus + A1 + A2 + PF + ESIC + Gratuity)
     * -------------------------------------------------------- */
    let specialAllowance =
        Math.round(grossCTC -
        (basic + hra + statBonus +
         allowance1 + allowance2 +
         pfEr + esicEr + gratuity));

    /* --------------------------------------------------------
     * 8Ô∏è‚É£ GUARANTEED CASH
     * -------------------------------------------------------- */
    let guaranteedCash =
        basic + hra + statBonus +
        allowance1 + allowance2 + specialAllowance;

    /* --------------------------------------------------------
     * 9Ô∏è‚É£ NET SALARY
     * -------------------------------------------------------- */
    let netSalary = guaranteedCash - pfEe - esicEe - profTax;

    /* --------------------------------------------------------
     * üîü FINAL CTC
     * -------------------------------------------------------- */
    let ctc = guaranteedCash + pfEr + esicEr + gratuity;

    /* --------------------------------------------------------
     * SET FIELD VALUES
     * -------------------------------------------------------- */
    const set = (id, val) => {
        if (document.getElementById(id))
            document.getElementById(id).value = val.toFixed(2);
    };

    // Monthly
    set("basic", basic);
    set("hra", hra);
    set("statBonus", statBonus);
    set("specialAllowance", specialAllowance);
    set("pfEr", pfEr);
    set("pfEe", pfEe);
    set("esicEr", esicEr);
    set("esicEe", esicEe);
    set("gratuity", gratuity);
    set("guaranteedCash", guaranteedCash);
    set("costToCompany", ctc);
    set("netSalary", netSalary);

    // Annual
    set("grossCTCAnn", grossCTC * 12);
    set("basicAnn", basic * 12);
    set("hraAnn", hra * 12);
    set("statBonusAnn", statBonus * 12);
    set("allowance1Ann", allowance1 * 12);
    set("allowance2Ann", allowance2 * 12);
    set("specialAllowanceAnn", specialAllowance * 12);
    set("guaranteedCashAnn", guaranteedCash * 12);
    set("pfErAnn", pfEr * 12);
    set("pfEeAnn", pfEe * 12);
    set("esicErAnn", esicEr * 12);
    set("esicEeAnn", esicEe * 12);
    set("gratuityAnn", gratuity * 12);
    set("profTaxAnn", profTax * 12);
    set("costToCompanyAnn", ctc * 12);
    set("netSalaryAnn", netSalary * 12);
}

/* --------------------------------------------------------
 * EVENT ATTACHMENTS
 * -------------------------------------------------------- */
document.addEventListener("DOMContentLoaded", () => {
    loadPayrollSettings();

    document.querySelectorAll("#incrementModal input, #incrementModal select").forEach(el => {
        el.addEventListener("input", calculateIncrementSalary);
        el.addEventListener("change", calculateIncrementSalary);
    });
});

/* --------------------------------------------------------
 * INCREMENT DETAILS MODAL LOADER
 * -------------------------------------------------------- */
async function viewIncrementDetails(id) {
    const modalBody = document.getElementById("incrementDetailsBody");
    modalBody.innerHTML = `<div class="text-center py-3"><i class="ri-loader-4-line ri-spin"></i> Loading...</div>`;

    new bootstrap.Modal(document.getElementById("incrementDetailsModal")).show();

    try {
        const res = await fetch(`/salary/increment/details/${id}/`);
        const data = await res.json();

        modalBody.innerHTML = `
            <table class="table table-bordered table-sm">
                <tr><th>Employee</th><td>${data.employee}</td></tr>
                <tr><th>Effective Date</th><td>${data.effective_date}</td></tr>
                <tr><th>Gross CTC</th><td>${data.gross_ctc_pm}</td></tr>
                <tr><th>Net Salary</th><td>${data.net_salary_pm}</td></tr>
                <tr><th>Reason</th><td>${data.reason || "-"}</td></tr>
                <tr><th>Status</th>
                    <td>${data.is_processed ? 
                        "<span class='badge bg-success'>Applied</span>" :
                        "<span class='badge bg-warning text-dark'>Pending</span>"
                    }</td>
                </tr>
            </table>
        `;
    } catch (err) {
        modalBody.innerHTML = `<div class="alert alert-danger">Failed to load details.</div>`;
    }
}
</script>
{% endblock %}
